<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="TrueNAS on ESXi with local storage" /><meta property="og:locale" content="en" /><meta name="description" content="In my homelab I try to use as little electricity as possible, not just because I live in The Netherlands and electricity is expensive, mostly because the house I live in is (climate/CO2) neutral and only has 6MWh of electricity per year available from the sun. Due to this I’d rather not have multiple servers continuously running, I much rather have just one piece of hardware. Since I wanted to have a NAS too, I figured I’d try to combine both in one physical server!" /><meta property="og:description" content="In my homelab I try to use as little electricity as possible, not just because I live in The Netherlands and electricity is expensive, mostly because the house I live in is (climate/CO2) neutral and only has 6MWh of electricity per year available from the sun. Due to this I’d rather not have multiple servers continuously running, I much rather have just one piece of hardware. Since I wanted to have a NAS too, I figured I’d try to combine both in one physical server!" /><link rel="canonical" href="https://mattstech.info/posts/truenas-on-esxi-with-local-storage/" /><meta property="og:url" content="https://mattstech.info/posts/truenas-on-esxi-with-local-storage/" /><meta property="og:site_name" content="Matts’ Tech Info" /><meta property="og:image" content="https://mattstech.info/assets/img/posts/headers/truenas-on-esxi.jpg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-08-13T00:57:21+02:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://mattstech.info/assets/img/posts/headers/truenas-on-esxi.jpg" /><meta property="twitter:title" content="TrueNAS on ESXi with local storage" /><meta name="twitter:site" content="@MattsTechInfo" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-06-23T23:11:23+02:00","datePublished":"2020-08-13T00:57:21+02:00","description":"In my homelab I try to use as little electricity as possible, not just because I live in The Netherlands and electricity is expensive, mostly because the house I live in is (climate/CO2) neutral and only has 6MWh of electricity per year available from the sun. Due to this I’d rather not have multiple servers continuously running, I much rather have just one piece of hardware. Since I wanted to have a NAS too, I figured I’d try to combine both in one physical server!","headline":"TrueNAS on ESXi with local storage","image":"https://mattstech.info/assets/img/posts/headers/truenas-on-esxi.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://mattstech.info/posts/truenas-on-esxi-with-local-storage/"},"url":"https://mattstech.info/posts/truenas-on-esxi-with-local-storage/"}</script><title>TrueNAS on ESXi with local storage | Matts' Tech Info</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Matts' Tech Info"><meta name="application-name" content="Matts' Tech Info"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script async src="https://stats.mattstech.info/visitors" data-website-id="6b086229-ba9b-48e4-970c-e94e6bef8b8e"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/logo-white-bg.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Matts' Tech Info</a></div><div class="site-subtitle font-italic">Sharing about all things tech!</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>BLOG</span> </a><li class="nav-item"> <a href="/projects/" class="nav-link"> <i class="fa-fw fas fa-cubes ml-xl-3 mr-xl-3 unloaded"></i> <span>PROJECTS</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/MattsTechInfo" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://discord.gg/v8Bwbnb3xe" aria-label="discord" target="_blank" rel="noopener"> <i class="fab fa-discord"></i> </a> <a href="https://twitter.com/MattsTechInfo" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" target="_blank" rel="noopener"> <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Blog </a> </span> <span>TrueNAS on ESXi with local storage</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>TrueNAS on ESXi with local storage</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1597273041" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Aug 13, 2020 </em> </span> <span> Updated <em class="" data-ts="1656018683" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jun 23, 2022 </em> </span><div class="mt-3 mb-3"> <img data-src="/assets/img/posts/headers/truenas-on-esxi.jpg" class="preview-img bg" alt="Preview Image" data-proofer-ignore></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/MattsBos">Matts Bos</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2753 words"> <em>15 min</em> read</span></div></div></div><div class="post-content"><p>In my homelab I try to use as little electricity as possible, not just because I live in The Netherlands and electricity is expensive, mostly because the house I live in is (climate/CO2) neutral and only has 6MWh of electricity per year available from the sun. Due to this I’d rather not have multiple servers continuously running, I much rather have just one piece of hardware. Since I wanted to have a NAS too, I figured I’d try to combine both in one physical server!</p><blockquote class="prompt-info"><div><p>This guide was originally written using FreeNAS and vSphere 6.7, the steps are still the same for vSphere 7.x and TrueNAS.</p></div></blockquote><blockquote class="prompt-warning"><div><p>Warning: TrueNAS does not support running inside a VM for production. <br /> VMware does not support RDM functionality with local disks.</p></div></blockquote><h2 id="why-truenas"><span class="mr-2">Why TrueNAS</span><a href="#why-truenas" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Some of you may have searched for NAS software, it’s likely that you ran into TrueNAS during your search. Packing ZFS technology for the storage layer, it’s completely different than your average hardware RAID card in most servers. It has a nice UI, iSCSI, NFS, everything you’d want from a NAS perspective (even VM support and “Jails”). The reason I went with TrueNAS is because of the whole package and my interest in ZFS with all it’s features.</p><p>Now for people having done more extensive research, you might have noticed their community forums are not so much of a happy place for people trying to run TrueNAS in a VM and asking questions about it. The reactions and links being posted to such questions are mostly based on ancient knowledge and not true for today, some even manage to claim the exact opposite of what the actual developers of TrueNAS say. I’m sure they mean to help, but I found that you shouldn’t write off TrueNAS because of this. I hope writing this blog will give you the correct information, unlike what can mostly be found online.</p><h2 id="requirements"><span class="mr-2">Requirements</span><a href="#requirements" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Naturally TrueNAS has a few requirements, most are nothing special but there are a few specifics. Make sure you verify all this up front, finding out your server hardware is insufficient halfway through can get quite expensive. TrueNAS has hardware requirements you actually have to think about before buying your server.</p><h3 id="processor"><span class="mr-2">Processor</span><a href="#processor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Mostly any modern processor will work fine. Inside a VM it can run on a single vCPU without problems. To give you an idea about performance, with a Xeon D-1541 @ 2.10GHz I can saturate 10Gb/s with a single core. I personally haven’t tested with encryption or higher bandwidth, but obviously, the faster your CPU the more performance you will get. I gave my TrueNAS vm 2 vCPU’s just to make sure I don’t get any performance problems. Oh yes, before you ask, 32bit x86 CPU’s are not considered modern…</p><p>As goes for any other VM, don’t give a VM more vCPU’s than it needs. The more you give, the lower the per-core performance gets due to scheduling. For example, a VM with 2 vCPU’s running at 60% load will perform better than a VM with 8vCPU’s running 15% load.</p><h3 id="memory"><span class="mr-2">Memory</span><a href="#memory" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now here’s where it gets interesting. Online you will find ginormous amounts of memory to supposedly be required by ZFS. My personal favorite you find everywhere when you search for memory requirements: “Rule of thumb for TrueNAS is 1GB ECC RAM per 1TB of storage space”. Forget it, that’s bollocks!</p><p><img data-src="/assets/img/posts/truenas-on-esxi-with-local-storage/memory-usage.png" alt="TrueNAS memory dashboard" style="max-width: 500px" class="right" data-proofer-ignore> First of all, what amount do you need? The developers of TrueNAS state that 8GB is the minimum and it does not have to be scaled up based on storage size. To give you an idea, I’m currently running 8GB on the VM with 46TB of raw storage spread over 7 disks. As you can see on the screenshot, 1.3GB of memory is in use by TrueNAS services, 0.2GB of memory is still available and a whopping 6GB is reserved for cache. Don’t ask me about the missing 0.5GB.</p><p>Now here comes the catch, if you want to run deduplication on a few TeraBytes of data, this is where the memory requirements come in. Some calculations show that, depending on the type of data, 1TB of data could possibly use up 5GB of memory using deduplication. It can also use as little as 0.5GB though. Conclusion is, deduplication is costly and you should ask yourself if you need it.</p><p>Next up, ECC vs non-ECC. Both work, but ECC is recommended to avoid errors in memory to potentially corrupt your whole storage. My personal view on this is, it all depends on how big you see the risk. In terms of numbers I’ve not seen many memory sticks go bad, 99% of the bad ones arrived in that state. TrueNAS works perfectly fine with normal non-ECC memory as long as you accept the risk that it could possibly, once in a lifetime chance, corrupt data. If you don’t want to take that risk, just go with ECC.</p><h3 id="disks-and-raidhbas"><span class="mr-2">Disks (and RAID/HBA’s)</span><a href="#disks-and-raidhbas" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now all of the above is pretty important, but where ZFS shines is the ability to manage the physical harddisks and overlaying the software RAID. This means that in absolutely all cases, no exceptions, <strong>no</strong> hardware RAID is allowed on the server! I can’t stress this enough, your RAID- or onboard controller has to be able to pass through the disks to the OS directly without any form of hardware RAID. The direct passthrough is often called JBOD. For most known RAID-controllers this is often referred to as IT-mode, not all RAID-controllers are capable of this, some may need to have their firmware flashed first, so choose wisely.</p><p>As for the actual disks, it’s your choice to go with SAS or SATA, it actually does not matter, all are supported. I’m running a combination of Enterprise SAS spinning disks and consumer grade SATA SSD’s. Also, my personal view on disks for any NAS system, please stay away from desktop drives (like WD Green and Blue) and get some good working storage, they don’t have to be that expensive. I would always prefer a refurbished enterprise HDD over desktop drives.</p><h2 id="installation"><span class="mr-2">Installation</span><a href="#installation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now that all requirements are out of the way, a small baseline of what I used for this build and blog:</p><ul><li>Intel Xeon D-1541 @ 2.10GHz (8 cores, 16 threads)<li>128GB DDR4, ECC-Registered memory<li>2x 10Gb/s SFP+ networking<li>Embedded LSI 3008 RAID controller<li>Embedded Marvell SATA controller<li>1x M.2 NVMe XPG GAMMIX S11 Pro 256GB (Consumer grade)<li>1x M.2 NVMe XPG GAMMIX S11 Pro 512GB (Consumer grade)<li>3x 14TB Seagate EXOS X16 SAS (Enterprise grade)<li>4x 1TB Samsung 860 EVO SSD (Consumer grade)<li>ESXi 6.7 Update 2</ul><h3 id="lsi-3008-raid-controller"><span class="mr-2">LSI 3008 RAID controller</span><a href="#lsi-3008-raid-controller" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This one is a bit special and I guessed/hoped it would work. The LSI 3008 controller is normally a physical add-on card for a PCIe slot, however, my motherboard has an embedded version of it and wasn’t sure how it would function. I just expected it to work the same as a physical card, which was confirmed after some testing. Unfortunately it had no possibility to use JBOD out of the box, fortunately it is based on the LSI 9300-8i controller which can be flashed to IT mode. After flashing, the controller is ready to go, if you need help with flashing, please do a search on the internet, there are countless tutorials available.</p><h3 id="marvell-sata-controller"><span class="mr-2">Marvell SATA controller</span><a href="#marvell-sata-controller" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This simple SATA controller already works as JBOD out of the box, there’s nothing else required to configure. Unfortunately, during the PCI passthrough configuration of this controller I noticed it didn’t disappear from the ESXi UI as an HBA. After some extensive research this Marvell controller has firmware problems that doesn’t allow it to be virtualized/passed through. My plan failed, as I require the disks directly passed to the TrueNAS VM. There was one solution left, which is setting up RDM in ESXi. More on that later.</p><h3 id="m2-nvme-256gb"><span class="mr-2">M.2 NVMe 256GB</span><a href="#m2-nvme-256gb" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Just because it’s possible I’ve added the 256GB NVMe SSD to the PCI passthrough. I will try to use this in the future as a caching solution inside TrueNAS, for now I just prepare it to be used and don’t actually use it yet. Maybe more on this in a following blog post. The reason I’m not using it yet is because TrueNAS already reserves memory for caching purposes. Since the current amount of memory is sufficient for cache and way faster than NVMe I have not yet required an additional caching mechanism. <img data-src="/assets/img/posts/truenas-on-esxi-with-local-storage/passthrough-1024x148.png" alt="Storage adapter ESXi passthrough" data-proofer-ignore></p><h3 id="truenas-vm"><span class="mr-2">TrueNAS VM</span><a href="#truenas-vm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>To start the installation of TrueNAS I created a VM with 2vCPU’s, 8GB memory and a 32GB Hard Disk. No other devices attached yet. Downloaded the latest TrueNAS version from the TrueNAS website and mounted the ISO to install the OS. Was as easy as one, two, three. Before I knew it I was browsing the web GUI. TrueNAS immediately grabs all the memory it can get, but as you can see in the screenshot about memory above, it doesn’t necessarily mean it’s not enough.</p><p><img data-src="/assets/img/posts/truenas-on-esxi-with-local-storage/VM.png" alt="TrueNAS VM" data-proofer-ignore></p><h4 id="networking"><span class="mr-2">Networking</span><a href="#networking" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The TrueNAS requirements also state that a minimum of one physical network port is required. This is based on a bare-metal install in a production environment. A lot of community answers tell you to dedicate a physical network port to the TrueNAS VM using passthrough. For ESXi, this is not true and really not necessary. ESXi internal network speed is way higher than your average physical network adapter. Maybe there are other hypervisors out there that might not be very efficient, having slower internal virtual networking than physical, ESXi has no such problems.</p><p>My personal setup consists of a dual VMXNET3 adapter, one is in my main VLAN where all my computers are attached to, to serve as NAS. The other network card is connected to a different portgroup specifically for storage access from my ESXi hosts. This network card is configured with Jumbo frames (MTU 9000) inside the TrueNAS OS to provide maximum throughput. Don’t forget that the whole network it’s connected to also has to support Jumbo frames, that includes the virtual switch! The choice is yours, it also works fine with a single network card.</p><h2 id="storage-physical"><span class="mr-2">Storage (physical)</span><a href="#storage-physical" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>As I mentioned above, I have two deviced passed through, directly into the VM. One is the LSI 3008 SAS controller and the other is the NVMe M.2 SSD. But there was also the problem with the SATA controller not being able to be passed through, which I solved with RDM’s. <img data-src="/assets/img/posts/truenas-on-esxi-with-local-storage/SAS-disks.png" alt="SAS disks overview" style="max-width: 300px" class="right" data-proofer-ignore></p><h3 id="sas-controller-and-nvme"><span class="mr-2">SAS Controller and NVMe</span><a href="#sas-controller-and-nvme" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>All disks attached to the LSI 3008 SAS controller are immediately visible in TrueNAS. I can see all their information and S.M.A.R.T. can be tested and read without problems. On the disk overview I see all three Seagates and the ADATA/XPG NVMe.</p><h4 id="check-sas-controller-presence"><span class="mr-2">Check SAS controller presence</span><a href="#check-sas-controller-presence" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>For the SAS controller you can verify if TrueNAS can see the hardware that was passed through with a CLI command from the Shell menu of TrueNAS. You can try the commands listed below, it only reads controller information, you can just try them both, nothing bad will happen.</p><p>For SAS3 controllers like my LSI 3008 controller use:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="go">sas3flash -listall
</span></pre></table></code></div></div><p>For SAS2 controllers (these are a little older) use:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="go">sas2flash -listall
</span></pre></table></code></div></div><h3 id="rdms-for-sata"><span class="mr-2">RDM’s for SATA</span><a href="#rdms-for-sata" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>A mentioned above, my Marvell SATA controller does not support PCI Passthrough, which means I just can’t directly attach the controller to the VM without having the hypervisor layer in between, which would be the easiest way, just like the SAS controller. However, there is another option for us ESXi users that, once again, is absolutely slammed by the TrueNAS community, RDM’s. A quick search on the web will show pretty much any thread regarding TrueNAS and RDM’s to advise you to avoid RDM’s at all cost. Some more research finds that all this information is based on some old facts for ESXi 3.x, a lot has changed and RDM’s work fine nowadays.</p><p>Please note, RDM’s have a lot of do’s and don’ts, it’s a very specific functionality to use LUN’s as disks on a remote system. In this case we are abusing this functionality for local disks. As mentioned in the disclaimer, this is not supported by VMware. Do this at your own risk, failure to understand how RDM’s work and bad configurations can possibly lead to corruption within TrueNAS. <a href="https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.vsphere.storage.doc/GUID-B3522FF1-76FF-419D-8DB6-F15BFD4DF12A.html" target="_blank" rel="noopener noreferrer">Please see the VMware documentation for all info regarding RDM’s. ⧉</a></p><h4 id="virtual-vs-physical-rdms"><span class="mr-2">Virtual vs Physical RDM’s</span><a href="#virtual-vs-physical-rdms" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Virtual RDM’s will give you a lot of options and functionality compared to Physical RDM’s. Things like creating VM snapshots, cloning, migrating or any other functionality that includes the RDM will only be possible on a Virtual RDM. The catch is, to gain this functionality, ESXi will abstract part of the storage layer and handle I/O commands on the hypervisor. This is exactly the functionality that will possibly kill your TrueNAS sooner or later. Bottomline: <strong>Never use Virtual RDM’s for TrueNAS disks!</strong></p><p>That means, when using RDM’s for TrueNAS, Physical RDM’s should always be used. In this case ESXi doesn’t interfere with the storage layer, it forwards all commands directly to the hardware as if the hypervisor isn’t there. TrueNAS will see the RDM as a local disk and can interact with the disk as if it was a local one. You will see no difference between a disk on the SAS controller and the RDM disk. Things like S.M.A.R.T. will also work because of this.</p><h4 id="configuring-rdms"><span class="mr-2">Configuring RDM’s</span><a href="#configuring-rdms" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>SSH access to the ESXi host is required to set up local RDM’s, make sure you have the SSH service enabled for the host. Log in to the ESXi host with SSH and use the following command to list your local disks:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="go">ls -l /vmfs/devices/disks
</span></pre></table></code></div></div><p>Depending on the number of disks in the server, the list can be quite long. Search for the disk names in the list, mine start with <code class="language-plaintext highlighter-rouge">t10.&lt;diskname&gt;&lt;serialnumber&gt;</code>.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="go">t10.ATA_____Samsung_SSD_860_EVO_1TB_________________S4X6NF0M847329D_____
t10.ATA_____Samsung_SSD_860_EVO_1TB_________________S4X6NF0M847334A_____
t10.ATA_____Samsung_SSD_860_EVO_1TB_________________S4X6NF0M847473B_____
t10.ATA_____Samsung_SSD_860_EVO_1TB_________________S4X6NF0M847568D_____
</span></pre></table></code></div></div><p>Copy the disks that need to be setup as an RDM to notepad, make sure to copy the full name, including all the underscores. Next thing is to find the location where the RDM links/vmdk’s should be placed. I placed them on the datastore the TrueNAS VM resides on and put it in the VM’s folder as only this VM will use them. For me that’s “mbesxi_local_nvme/mbnas1”.</p><p>Now with the disks and the location for the RDM links combine them into the create RDM command, I simply call disk one -&gt; rdm1, disk two -&gt; rdm2, etc.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="go">vmkfstools -z /vmfs/devices/disks/t10.ATA_____Samsung_SSD_860_EVO_1TB_________________S4X6NF0M847329D_____ "/vmfs/volumes/mbesxi_local_nvme/mbnas1/rdm1.vmdk"
vmkfstools -z /vmfs/devices/disks/t10.ATA_____Samsung_SSD_860_EVO_1TB_________________S4X6NF0M847334A_____ "/vmfs/volumes/mbesxi_local_nvme/mbnas1/rdm2.vmdk"
vmkfstools -z /vmfs/devices/disks/t10.ATA_____Samsung_SSD_860_EVO_1TB_________________S4X6NF0M847473B_____ "/vmfs/volumes/mbesxi_local_nvme/mbnas1/rdm3.vmdk"
vmkfstools -z /vmfs/devices/disks/t10.ATA_____Samsung_SSD_860_EVO_1TB_________________S4X6NF0M847568D_____ "/vmfs/volumes/mbesxi_local_nvme/mbnas1/rdm4.vmdk"
</span></pre></table></code></div></div><p>After running the above commands the rdm1 to rdm4 VMDK’s should be in the chosen location and are ready to be consumed by the TrueNAS VM. <img data-src="/assets/img/posts/truenas-on-esxi-with-local-storage/rdm-vmdk.png" alt="rdm on datastore" data-proofer-ignore></p><h4 id="physical-rdm-vm-configuration"><span class="mr-2">Physical RDM VM configuration</span><a href="#physical-rdm-vm-configuration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>With the RDM’s created in the above step, they can now be added to the TrueNAS VM. Again, there are a few things that need to be considered:</p><ul><li>A virtual storage controller with physical functionality is required.<li>Make sure the RDM runs Physical mode.</ul><p>The virtual storage controller should default to LSI Logic SAS when creating a VM in ESXi, but if there is a different SCSI controller, it will not work since those don’t have the physical disk functions in them. I like to keep my RDM’s on a separate controller, this is not based on any requirement or recommendation. You can also add the RDM’s to any LSI Logic SAS controller you have on the VM. Note, I have not tested with a SATA controller.</p><p>Now edit the TrueNAS VM settings and add a new LSI Logic SAS controller if you want to, if not, continue adding the RDM’s VMDK’s from the datastore. This is done by adding a new device “Existing Hard Disk” and <strong>not</strong> “RDM Disk”. In my screenshot you will see I added a new SCSI controller and added 3 existing hard disks to the new controller.</p><ul><li>(Optional) New controller: LSI Logic SAS<li>Existing Hard Disk: rdm1.vmdk<ul><li>Compatibility Mode: Physical<li>Mode: Independent Persistent<li>(Optional) SCSI Controller: 1</ul><li>Repeat adding Existing Hard Disk for all RDM’s. <img data-src="/assets/img/posts/truenas-on-esxi-with-local-storage/Add-existing.png" alt="Add VM hardware" data-proofer-ignore></ul><p>That’s it! Now all the RDM’s are available in the correct way, without any filtering from the Hypervisor storage layer. TrueNAS will recognize the disks and will be able to do everything with them as if they were directly attached as a local disk. You can not see the difference from within TrueNAS.</p><p>Now it’s time to configure the storage pools, which will be different for everyone and has nothing to do with ESXi anymore. Please see the TrueNAS documentation how to continue from this point on.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/documentation/'>Documentation</a>, <a href='/categories/tutorials/'>Tutorials</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/documentation/" class="post-tag no-text-decoration" >documentation</a> <a href="/tags/homelab/" class="post-tag no-text-decoration" >homelab</a> <a href="/tags/truenas/" class="post-tag no-text-decoration" >truenas</a> <a href="/tags/storage/" class="post-tag no-text-decoration" >storage</a> <a href="/tags/vmware/" class="post-tag no-text-decoration" >vmware</a> <a href="/tags/esxi/" class="post-tag no-text-decoration" >esxi</a> <a href="/tags/vsphere6/" class="post-tag no-text-decoration" >vsphere6</a> <a href="/tags/vsphere7/" class="post-tag no-text-decoration" >vsphere7</a> <a href="/tags/tutorial/" class="post-tag no-text-decoration" >tutorial</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=TrueNAS+on+ESXi+with+local+storage+-+Matts%27+Tech+Info&url=https%3A%2F%2Fmattstech.info%2Fposts%2Ftruenas-on-esxi-with-local-storage%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=TrueNAS+on+ESXi+with+local+storage+-+Matts%27+Tech+Info&u=https%3A%2F%2Fmattstech.info%2Fposts%2Ftruenas-on-esxi-with-local-storage%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fmattstech.info%2Fposts%2Ftruenas-on-esxi-with-local-storage%2F&text=TrueNAS+on+ESXi+with+local+storage+-+Matts%27+Tech+Info" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/nvme-ssd-not-recognized-update/">NVMe SSD not recognized - Update</a><li><a href="/posts/big-tesla-update/">Big update for older Tesla's just dropped! (2022.8.10.5)</a><li><a href="/posts/fujitsu-waterstage-domotica/">Fujitsu Waterstage home automation/domotica</a><li><a href="/posts/fujitsu-bsblan-monitoring/">Fujitsu BSB-LAN Monitoring</a><li><a href="/posts/save-with-instant-heaters/">Saving Energy - Close-in boiler or instant heater?</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/vmware/">vmware</a> <a class="post-tag" href="/tags/documentation/">documentation</a> <a class="post-tag" href="/tags/events/">events</a> <a class="post-tag" href="/tags/tutorial/">tutorial</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/esxi/">esxi</a> <a class="post-tag" href="/tags/vmworld/">vmworld</a> <a class="post-tag" href="/tags/storage/">storage</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/nvme/">nvme</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div><script type='text/javascript' src='/assets/js/dist/custom.js'></script><div id="kofi-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Is this helpful? <script type='text/javascript' src='https://storage.ko-fi.com/cdn/widget/Widget_2.js'></script><script type='text/javascript'>kofiwidget2.init('Support Me on Ko-fi', '#42424247', 'L4L4EW4I7');kofiwidget2.draw();</script></div></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div class="post-navigation d-flex justify-content-between"> <a href="/posts/vmware-homelab-101/" class="btn btn-outline-primary" prompt="Older"><p>VMware Homelab 101</p></a> <a href="/posts/nvme-ssd-not-recognized-7-0/" class="btn btn-outline-primary" prompt="Newer"><p>NVMe SSD not recognized 7.0+</p></a></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "mattstechinfo/mattstechinfo.github.io", "data-repo-id": "R_kgDOHfb7oA", "data-category": "Comments", "data-category-id": "DIC_kwDOHfb7oM4CPx9S", "data-mapping": "title", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "top", "data-lang": "en", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/MattsBos">Matts Bos</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/vmware/">vmware</a> <a class="post-tag" href="/tags/documentation/">documentation</a> <a class="post-tag" href="/tags/events/">events</a> <a class="post-tag" href="/tags/tutorial/">tutorial</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/esxi/">esxi</a> <a class="post-tag" href="/tags/vmworld/">vmworld</a> <a class="post-tag" href="/tags/storage/">storage</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/nvme/">nvme</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script>
